# 数据库配置说明

## 概述

星火自动化测试平台支持两种数据库模式：
- **SQLite模式**（默认）：本地文件数据库，开箱即用
- **MySQL模式**：远程数据库，适合生产环境部署

## 配置方式

### 1. 环境变量配置

#### SQLite模式（默认）
```bash
# 不设置任何环境变量，或设置为sqlite
export DATABASE_TYPE=sqlite
```

#### MySQL模式
```bash
export DATABASE_TYPE=mysql
export MYSQL_HOST=your_mysql_host
export MYSQL_PORT=3306
export MYSQL_USER=your_username
export MYSQL_PASSWORD=your_password
export MYSQL_DATABASE=automation
```

### 2. Windows环境变量设置

在Windows系统中，可以通过以下方式设置环境变量：

**临时设置（当前会话）：**
```cmd
set DATABASE_TYPE=mysql
set MYSQL_HOST=localhost
set MYSQL_USER=root
set MYSQL_PASSWORD=your_password
set MYSQL_DATABASE=automation
```

**永久设置：**
1. 右键"此电脑" → "属性" → "高级系统设置"
2. 点击"环境变量"
3. 在"系统变量"中添加相应的环境变量

## 数据库文件说明

### SQLite数据库文件
- **文件路径**：`automation.db`
- **位置**：项目根目录
- **特点**：
  - 无需安装额外软件
  - 支持WAL模式，提高并发性能
  - 自动创建和初始化
  - 适合开发和测试环境

### MySQL数据库
- **要求**：需要安装MySQL服务器
- **字符集**：utf8mb4
- **引擎**：InnoDB
- **特点**：
  - 支持多用户并发访问
  - 数据安全性更高
  - 适合生产环境部署
  - 支持主从复制和集群

## 表结构说明

### 核心表

#### 1. users（用户表）
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE
);
```

#### 2. projects（项目表）
```sql
CREATE TABLE projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    product_package_name VARCHAR(255) NOT NULL,
    product_address TEXT NOT NULL,
    product_id VARCHAR(255),
    is_automated VARCHAR(10) NOT NULL,
    version_number VARCHAR(100),
    product_image TEXT,
    system_type VARCHAR(100),
    product_type VARCHAR(100),
    environment VARCHAR(100),
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3. automation_projects（自动化项目表）
```sql
CREATE TABLE automation_projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    process_name VARCHAR(255) NOT NULL,
    product_ids TEXT NOT NULL,
    system VARCHAR(100),
    product_type VARCHAR(100),
    environment VARCHAR(100),
    product_address TEXT,
    test_steps TEXT,
    status VARCHAR(50) DEFAULT '待执行',
    created_by VARCHAR(100) DEFAULT 'admin',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 4. automation_executions（执行记录表）
```sql
CREATE TABLE automation_executions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    process_name VARCHAR(255) NOT NULL,
    product_ids TEXT NOT NULL,
    system VARCHAR(100),
    product_type VARCHAR(100),
    environment VARCHAR(100),
    product_address TEXT,
    status VARCHAR(50) NOT NULL,
    start_time TIMESTAMP NULL,
    end_time TIMESTAMP NULL,
    log_message TEXT,
    detailed_log TEXT,
    executed_by VARCHAR(100) DEFAULT 'admin',
    FOREIGN KEY (project_id) REFERENCES automation_projects (id)
);
```

## 迁移指南

### 从SQLite迁移到MySQL

#### 1. 安装MySQL依赖
```bash
pip install pymysql cryptography
```

#### 2. 设置环境变量
```bash
export DATABASE_TYPE=mysql
export MYSQL_HOST=your_mysql_host
export MYSQL_USER=your_username
export MYSQL_PASSWORD=your_password
export MYSQL_DATABASE=automation
```

#### 3. 运行迁移脚本
```bash
python scripts/migrate_database.py
```

### 从MySQL迁移到SQLite

#### 1. 设置环境变量
```bash
export DATABASE_TYPE=sqlite
# 或者删除所有数据库相关的环境变量
```

#### 2. 重新启动应用
应用会自动创建SQLite数据库文件

## 性能优化

### SQLite优化
- 启用WAL模式（已配置）
- 设置合适的缓存大小（已配置为10000）
- 使用内存临时存储（已配置）

### MySQL优化
- 配置合适的连接池大小
- 设置适当的字符集和排序规则
- 根据数据量调整InnoDB缓冲池大小

## 故障排除

### 常见问题

#### 1. 数据库连接失败
- 检查环境变量是否正确设置
- 确认数据库服务是否运行
- 验证用户名和密码是否正确

#### 2. 权限不足
- 确保MySQL用户有足够的权限
- 检查数据库是否存在
- 验证用户是否有CREATE、INSERT、SELECT等权限

#### 3. 字符集问题
- 确保MySQL使用utf8mb4字符集
- 检查连接字符串中的字符集设置

### 调试工具

#### 1. 配置检查脚本
```bash
python scripts/check_database_config.py
```

#### 2. 数据库连接测试
```bash
python scripts/test_db_connection.py
```

## 安全建议

### 生产环境部署
1. 使用强密码
2. 限制数据库访问IP
3. 定期备份数据
4. 启用SSL连接（MySQL）
5. 使用专用数据库用户，避免使用root

### 开发环境
1. 使用本地数据库
2. 避免在代码中硬编码密码
3. 使用环境变量管理敏感信息

## 备份和恢复

### SQLite备份
```bash
# 简单复制
cp automation.db automation_backup.db

# 使用sqlite3工具
sqlite3 automation.db ".backup automation_backup.db"
```

### MySQL备份
```bash
# 使用mysqldump
mysqldump -h host -u user -p database_name > backup.sql

# 恢复
mysql -h host -u user -p database_name < backup.sql
```

## 监控和维护

### 定期维护任务
1. 清理过期日志数据
2. 优化数据库性能
3. 检查磁盘空间使用情况
4. 验证数据完整性

### 性能监控
1. 监控查询执行时间
2. 检查连接池使用情况
3. 分析慢查询日志
4. 监控数据库资源使用情况 